<div class="flexcol h-full !items-start">
  <div class="toolbar flexrow">
    <button (click)="addNode()" class="bg-primary" title="Add Node">
      <lucide-icon [img]="WorkflowIcon"></lucide-icon> Add Nodes
    </button>
    <select [(ngModel)]="connectionStyle" (change)="applyConnectionStyle()" class="bg-primary input mt-2 text-white p-2">
      <option value="straight">Straight</option>
      <option value="curve">Curve</option>
      <option value="angle">Angle</option>
    </select>

    <button (click)="enableConnect()" class="bg-primary" title="Connect">
      <lucide-icon [img]="SplineIcon"></lucide-icon> Connect Nodes
    </button>

    <button (click)="layout()" class="bg-primary" title="Auto Layout">
      <lucide-icon [img]="GitBranchPlusIcon"></lucide-icon> Auto Layout
    </button>

    <button (click)="saveLocal()" class="bg-primary" title="Save">
      <lucide-icon [img]="SaveIcon"></lucide-icon> Save Diagrams
    </button>

    <button (click)="openSheetImport()" class="bg-primary" title="Import Sheet">
      <lucide-icon [img]="UploadSheetIcon"></lucide-icon> Upload G-Sheet
    </button>

    <button (click)="showMappingModal = true" class="bg-primary" title="Map Columns">
      <lucide-icon [img]="SelectNodeIcon"></lucide-icon> Map Columns
    </button>

    <button (click)="colorNodes()" class="bg-primary" title="Color">
      <lucide-icon [img]="PaletteIcon"></lucide-icon> Color Nodes
    </button>

    <button (click)="refreshFromSheet()" class="bg-primary" title="Re-layout">
      <lucide-icon [img]="RefreshIcon"></lucide-icon> Refresh Data
    </button>
  </div>

  <div #cyContainer class="cy border"></div>
</div>

<!-- SAVE DIAGRAMS MODAL -->
<div *ngIf="ShowSavingModal" class="modal">
  <div class="modal-content">
    <form (ngSubmit)="saveDiagramsInformation()">
      <h3>Diagrams Information</h3>

      <label>Diagram Name</label>
      <input type="text" name="name" [(ngModel)]="diagramsField.name" placeholder="Name" class="input">

      <label>Description</label>
      <textarea name="description" [(ngModel)]="diagramsField.description" placeholder="Description" class="input"></textarea>

      <div class="modal-actions">
        <button class="btn" type="submit">Save Diagrams Information</button>
        <button class="btn" type="button" (click)="ShowSavingModal = false">Close</button>
      </div>
    </form>
  </div>
</div>

<!-- COLOR NODES MODAL -->
<div *ngIf="ShowColorModal" class="modal">
  <div class="modal-content">
    <form (ngSubmit)="saveColorDiagramsInformation()">
      <h3>Color Information</h3>

      <label>Label</label>
      <input type="text" name="label" [(ngModel)]="ColorNodeFields.label" placeholder="Label" class="input">

      <label>Color</label>
      <input type="color" name="color_code" [(ngModel)]="ColorNodeFields.color_code" class="input">

      <div class="modal-actions">
        <button class="btn" type="submit">Save Color</button>
        <button class="btn" type="button" (click)="ShowColorModal = false">Close</button>
      </div>
    </form>
  </div>
</div>
<div *ngIf="showImportModal" class="modal">
  <div class="modal-content">
    <h3>Import Google Sheet</h3>

    <label>Google Sheet URL:</label>
    <input [(ngModel)]="sheetUrl" placeholder="Paste Google Sheet link here" class="input">

    <div class="modal-actions">
      <button class="btn" (click)="loadSheet()">Load Sheet</button>
      <button class="btn" (click)="showImportModal = false">Close</button>
    </div>

    <div *ngIf="headers.length">
      <h4>Detected Headers</h4>
      <ul class="small-list">
        <li *ngFor="let h of headers; let i = index">Column {{ i + 1 }} — {{ h || 'Column ' + (i+1) }}</li>
      </ul>
      <p class="muted">After loading the sheet you can map which columns represent ID, Label, and Dependency.</p>
    </div>
  </div>
</div>

<!-- MAPPING MODAL (dynamic mapping) -->
<div *ngIf="showMappingModal" class="modal">
  <div class="modal-content">
    <h3>Map Columns → Node</h3>

    <div *ngIf="!headers.length">
      <p>No sheet loaded yet. Click <strong>Import Sheet</strong> and load a Google Sheet first.</p>
      <div class="modal-actions">
        <button class="btn" (click)="showMappingModal = false">Close</button>
      </div>
    </div>

    <div *ngIf="headers.length">
      <label>Node ID column</label>
      <select [(ngModel)]="mapping.id" class="input">
        <option *ngFor="let h of headers; let i = index" [value]="i">{{ h || 'Column ' + (i+1) }}</option>
      </select>

      <label>Label column</label>
      <select [(ngModel)]="mapping.label" class="input">
        <option *ngFor="let h of headers; let i = index" [value]="i">{{ h || 'Column ' + (i+1) }}</option>
      </select>

      <label>Does this file include dependencies?</label>
      <div class="row">
        <label class="inline">
          <input type="radio" name="hasDep" [checked]="mapping.dependency !== null" (click)="mapping.dependency = null; mapping.dependency = null; mapping.dependency = null;"/>
          No
        </label>
        <label class="inline">
          <input type="radio" name="hasDep" [checked]="mapping.dependency !== null" (click)="mapping.dependency =  (headers.length > 0 ? 0 : null)"/>
          Yes
        </label>
      </div>

      <div *ngIf="mapping.dependency !== null">
        <label>Dependency column (comma separated values expected)</label>
        <select [(ngModel)]="mapping.dependency" class="input">
          <option *ngFor="let h of headers; let i = index" [value]="i">{{ h || 'Column ' + (i+1) }}</option>
        </select>
      </div>
      <div *ngFor="let header of headers; let index = index">
        <input type="checkbox" [(ngModel)]="selectedNodeDisplay[index]">
        <label for="">{{header || '-'}}</label>
      </div>
      <div class="modal-actions">
        <button class="btn" (click)="generateNodesDynamic(); showMappingModal = false">Generate Nodes</button>
        <button class="btn" (click)="showMappingModal = false">Close</button>
      </div>
    </div>
  </div>
</div>
