<div class="flexcol h-full !items-start">
  <div class="toolbar !gap-2 flexrow">
    <button (click)="addNode()" class="bg-primary" title="Add Node">
      <lucide-icon [img]="WorkflowIcon" [size]="15"></lucide-icon>Nodes
    </button>

    <select [(ngModel)]="connectionStyle" (change)="applyConnectionStyle()" class="bg-primary input text-white p-2 text-[12px]">
      <option value="straight">Straight</option>
      <option value="angle">Angle</option>
    </select>

    <button (click)="enableConnect()" class="bg-primary" title="Connect">
      <lucide-icon [img]="GitBranchPlusIcon" [size]="15"></lucide-icon>Connect
    </button>

    <!-- <button (click)="autoLayoutByTargetEnd()" class="bg-primary text-sm" title="Auto Layout">
      <lucide-icon [img]="ShapesIcon"></lucide-icon>Layout
    </button> -->

    <button (click)="saveLocal()" class="bg-primary" title="Save">
      <lucide-icon [img]="SaveIcon" [size]="15"></lucide-icon>Save
    </button>

    <button (click)="openSheetImport()" class="bg-primary" title="Import Sheet">
      <lucide-icon [img]="UploadSheetIcon" [size]="15"></lucide-icon>Upload
    </button>

    <button (click)="showMappingModal = true" class="bg-primary" title="Map Columns">
      <lucide-icon [img]="SelectNodeIcon" [size]="15"></lucide-icon>Map
    </button>

    <button (click)="refreshFromSheet()" class="bg-primary" title="Re-layout">
      <lucide-icon [img]="RefreshIcon" [size]="15"></lucide-icon>Refresh
    </button>
    <button (click)="enableLineMode()" class="bg-primary" title="Draw Line">
      <lucide-icon [img]="SlashIcon" [size]="15"></lucide-icon>Line
    </button>
    <button (click)="snapHorizontal()" class="bg-primary" title="Draw Line">
      <lucide-icon [img]="SlashIcon" [size]="15"></lucide-icon>Horizontal
    </button>
    <button (click)="addLabel()" class="bg-primary" title="Add Label">
      <lucide-icon [img]="TypeIcon" [size]="15"></lucide-icon>Label
    </button>
    <input [(ngModel)]="searchQuery" (keyup.enter)="searchNodes()" class="p-1 border rounded-xl" placeholder="Search nodes...">
    <button (click)="searchNodes()" class="bg-primary !px-4">Search</button>
    <button (click)="previousSearchResult()" class="bg-primary"><lucide-icon [img]="PreviousIcon" [size]="15"></lucide-icon></button>
    <button (click)="nextSearchResult()" class="bg-primary"><lucide-icon [img]="NextIcon" [size]="15"></lucide-icon></button>
    <button (click)="clearSearch()" class="bg-primary">Clear</button>
    <button (click)="autoLayout()" class="bg-primary">Auto Layout</button>
  </div>

  <div #cyContainer class="cy h-full relative">
    <div class="bg-black/30 absolute bottom-3 right-3 p-2 py-4 rounded-xl flexcol z-50">
      <button (click)="zoomIn()" class="p-2 rounded-lg bg-black/50" title="Zoom In"> <lucide-icon [img]="ZoomInIcon" [size]="15"></lucide-icon></button>
      <button (click)="zoomOut()" class="p-2 rounded-lg bg-black/50" title="Zoom Out"> <lucide-icon [img]="ZoomOutIcon" [size]="15"></lucide-icon></button>
      <button (click)="resetZoom()" class="p-2 rounded-lg bg-black/50" title="Zoom Reset"> <lucide-icon [img]="ZoomResetIcon" [size]="15"></lucide-icon></button>
      <button (click)="zoomToFit()" class="p-2 rounded-lg bg-black/50" title="Fit to Screen"> <lucide-icon [img]="ZoomFitIcon" [size]="15"></lucide-icon></button>
    </div>
  </div>
</div>

<div *ngIf="ShowSavingModal" class="modal">
  <div class="modal-content">
    <form (ngSubmit)="saveDiagramsInformation()">
      <h3>Diagrams Information</h3>
      <div>
        <div class="flexcol !items-start w-full">
          <label>Diagram Name</label>
          <input type="text" name="name" [(ngModel)]="diagramsField.name" placeholder="Name" class="input w-full">
        </div>
        <div class="flexcol !items-start w-full">
          <label>Description</label>
          <textarea name="description" [(ngModel)]="diagramsField.description" placeholder="Description" class="input w-full"></textarea>
        </div>
      </div>
      <div class="modal-actions mt-3 flexrow gap-3">
        <button class="btn" type="submit">Save Diagrams Information</button>
        <button class="btn !bg-red-600" type="button" (click)="ShowSavingModal = false">Close</button>
      </div>
    </form>
  </div>
</div>

<div *ngIf="ShowColorModal" class="modal">
  <div class="modal-content">
    <form (ngSubmit)="saveColorDiagramsInformation()">
      <h3>Color Information</h3>

      <label>Label</label>
      <input type="text" name="label" [(ngModel)]="ColorNodeFields.label" placeholder="Label" class="input">

      <label>Color</label>
      <input type="color" name="color_code" [(ngModel)]="ColorNodeFields.color_code" class="input">

      <div class="modal-actions">
        <button class="btn" type="submit">Save Color</button>
        <button class="btn" type="button" (click)="ShowColorModal = false">Close</button>
      </div>
    </form>
  </div>
</div>

<div *ngIf="showImportModal" class="modal">
  <div class="modal-content">
    <h3>Import Google Sheet</h3>

    <label>Google Sheet URL:</label>
    <input [(ngModel)]="sheetUrl" placeholder="Paste Google Sheet link here" class="input">

    <div class="modal-actions">
      <button class="btn" (click)="loadSheet()">Load Sheet</button>
      <button class="btn" (click)="showImportModal = false">Close</button>
    </div>
  </div>
</div>

<div *ngIf="showMappingModal" class="modal">
  <div class="modal-content">
    <header class="font-semibold text-2xl">Column Mapper</header>

    <div *ngIf="!headers.length">
      <p>No sheet loaded yet. Click <strong>Import Sheet</strong> and load a Google Sheet first.</p>
      <div class="modal-actions">
        <button class="btn" (click)="showMappingModal = false">Close</button>
      </div>
    </div>

    <div *ngIf="headers.length">
      <div class="flexcol w-full !justify-start !items-start">
        <div class="flexcol !gap-1 !items-start w-full">
          <label>Node ID column</label>
          <select [(ngModel)]="mapping.id" class="input w-full">
            <option *ngFor="let h of headers; let i = index" [ngValue]="i">{{ h || 'Column ' + (i+1) }}</option>
          </select>
        </div>

        <div class="flexcol !gap-1 !items-start w-full">
          <label>Label column</label>
          <select [(ngModel)]="mapping.label" class="input w-full">
            <option *ngFor="let h of headers; let i = index" [ngValue]="i">{{ h || 'Column ' + (i+1) }}</option>
          </select>
        </div>
      </div>

      <label>Does this file include dependencies?</label>
      <div class="row">
        <label class="inline">
          <input type="radio" name="hasDep" [checked]="mapping.dependency === null" (click)="mapping.dependency = null"/>
          No
        </label>
        <label class="inline">
          <input type="radio" name="hasDep" [checked]="mapping.dependency !== null" (click)="mapping.dependency =  (headers.length > 0 ? 0 : null)"/>
          Yes
        </label>
      </div>

      <div *ngIf="mapping.dependency !== null" class="flexcol !items-start">
        <label>Dependency column (comma separated values expected)</label>
        <select [(ngModel)]="mapping.dependency" class="input w-full">
          <option *ngFor="let h of headers; let i = index" [ngValue]="i">{{ h || 'Column ' + (i+1) }}</option>
        </select>
      </div>

      <label>Add Filter?</label>
      <div class="row">
        <label class="inline">
          <input type="radio" name="hasFil" [checked]="mapping.filter === null" (click)="mapping.filter = null"/>
          No
        </label>
        <label class="inline">
          <input type="radio" name="hasFil" [checked]="mapping.filter !== null" (click)="mapping.filter =  (headers.length > 0 ? 0 : null)"/>
          Yes
        </label>
      </div>
      <div *ngIf="mapping.filter !== null" class="flexcol !items-start">
        <label>Select Filter Column</label>
        <select [(ngModel)]="mapping.filter" class="input w-full" (change)="onFilterColumnChange()">
          <option *ngFor="let h of headers; let i = index" [ngValue]="i">{{ h || 'Column ' + (i+1) }}</option>
        </select>
      </div>

      <div *ngIf="filterValues.length > 0" class="flexcol !items-start mt-2">
        <label>Select Filter Value</label>
        <select [(ngModel)]="selectedFilterValue" class="input w-full">
          <option *ngFor="let val of filterValues" [value]="val">{{ val }}</option>
        </select>
      </div>
      <header class="font-semibold text-lg mt-3 mb-1">Select Columns to Display</header>
      <div class="preview grid grid-cols-3 mb-5">
        
        <div *ngFor="let header of headers; let index = index" class="map-checkbox">
          <input type="checkbox" [(ngModel)]="selectedNodeDisplay[index]">
          <label>{{header || '-'}}</label>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" (click)="generateNodesDynamic(); showMappingModal = false">Generate Nodes</button>
        <button class="btn" (click)="showMappingModal = false">Close</button>
      </div>
    </div>
  </div>
</div>
